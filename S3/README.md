# s3について

- ストレージクラス
  - スタンダード
  - STANDARD-IA(格納コストは安価だが、データのよみ出し容量に対して課金)
  - Glacier
  - RRS(Reduced Redundancy Storage) Glacierから取り出したデータの置き場所として利用

- S3のData Consistencyモデル
  - 複数の場所に複製することで高い可用性を実現するため、データの更新・削除には　`結果整合性` が採用
  - 新規登録: 登録後、即時データが参照可能
  - 更新: 更新直後は、以前のデータが参照される可能性がある
  - 削除: 削除直後は、削除前のデータが参照される可能性がある

- S3の操作
  - GET/PUT/LIST/COPY/DELETE
  - HEAD: オブジェクトのメタデータを取得
  - RESTORE: アーカイブされたオブジェクトを一時的にS3に取り出し
  
- アクセス管理 
  - ユーザポリシー
    - IAMユーザに対して、s3やバケットへのアクセス権限を設定
    - 複数バケットやs3以外のものも含めて、一元的にユーザ権限を指定する場合
    - Condition要素を利用して接続元IPアドレス制限なども指定できる
  - バケットポリシー 
    - s3バケットごとに、アクセス権限を指定
    - クロスアカウントでのs3バケットアクセス権を付与する場合
    - Condition要素を利用して接続元IPアドレス、IAMユーザ、クロスアカウント、CloudFront,MFA制限なども可能
  - ACL
    - 各バケットおよび、オブジェクトのアクセス権限を指定
    - バケット単位やオブジェクト単位で簡易的に権限を付与する場合
    - ユーザポリシーやバケットポリシーが優先される
    - バケットACLよりオブジェクトACLが優先される
  
- Pre-signed Object URL(署名付きURL)
  - SDKを利用して生成される署名されたURLを利用して、s3上のプライベートなオブジェクトに対して一定時間アクセスを許可
  - GET/PUTが利用可能

- webサイトホスティング機能
  - バケット単位で指定
    - Management Consoleから設定可能
    - パブリックアクセスを許可するために、別途、バケットポリシーで全ユーザにGET権限を付与
  - 独自ドメインの 指定
    - ドメイン名をバケット名として指定
      - 通常は `http://バケット名.s3-website-<region>.amazon.com`
    - 　Route53のAlias設定でドメイン名S3のバケット名を紐付けたレコードを登録
  - リダイレクト機能

- S3 support for IPv6
  - IPv4/v6の両方をデュアルスタックエンドポイントにてサポート
  - 追加費用なし
  - AWS SDK/CLIで利用可能
  - 静的ウェブホスティングでは利用できない
  - IPv6ベースのアクセス制御が可能
  
- 暗号化によるデータ保護
  - 保管時(s3データセンター内のディスクに格納されているときのデータを暗号化して保護するもの)
  - サーバサイド暗号化
    - AWSのサーバリリースを利用して格納データの暗号化処理を実施
      - SSE-S3: AWSが管理する鍵を利用して暗号化
      - SSE-KMS AWS(KMS)の鍵を利用して暗号化
      - SSE-C: ユーザが提供した鍵を利用して暗号化(AWSで鍵は管理しない)
    - クライアントサイド暗号化
      - 暗号化プロセスはユーザ管理
      - クライアント側で暗号化したデータをS3にアップロード

- クロスリージョンレプリケーション
  - 異なるリージョン間のS3バケットオブジェクトのレプリケーションを実施
  - バケットに対するオブジェクトの作成・更新・削除をトリガーに非同期でレプリケーションが実行
    - 送信元バケットはバージョニングの機能を有効にする
    - バケットはそれぞれ異なるリージョンであること
    - 双方向レプリケーションも可能
    - レプリケーション時は、リージョン間データ転送費用が発生

- バージョン管理機能
  - ユーザやアプリケーションの号操作による削除対策
  - バケットに対して設定
  - バージョン保管されている任意のオブジェクトを参照可能
  - バージョニングより保管されているオブジェクト分も課金
  - ライフサイクル管理も連携できる
  - バケットを削除したい場合は、古いバージョンのオブジェクトも削除する

- アーカイブ及び復元
  - アーカイブ
    - オブジェクトのデータはGlacierに移動(アーカイブ後はGlacier)
    - s3上のデータを削除することでGlaicer側のデータも削除される
    - s3には8KBのオブジェクト名とメタデータのみが保管
    - Glacierには32KBのインデックスおよび管理メータデータが追加で保管
    - アーカイブしたオブジェクトを90日以内に削除しても、90日間アーカイブされたのと同じ課金対象
  - オブジェクトの復元
    - オブジェクト毎に 復元
    - データは一時的にs3の低冗長化ストレージに指定日数間複製される
    - 復元期間中は、s3の低冗長化ストレージとGlacier双方で課金

- s3イベント通知
  - SNS/SQS/Lambdaに対して通知して連携が可能
  
- Cloudwatchによるメトリクス管理
  - バケットに対するストレージメトリクスは日単位
  - オブジェクトに対するリクエストメトリクスは分単位

- モニタリングや管理に有効な機能
  - Logging
    - バケット単位でバケットに対するアクセスログの出力設定が可能
    - 出力先としてs3バケット
  - Tag
    - バケットに対してタグ指定が可能
    - オブジェクトに対してもタグが設定可能
    
- パフォーマンスの最適化
  - GETリクエストについて、`RANGE GET`を活用することでマルチスレッド環境では高速にダウンロードが可能
  - チャンクサイズと並列コネクション数のバランスが大事
  - 100MB以上のファイルのアップロードをマルチパートアップロードで高速化
  - マルチアップロードをりようすることで5TBまで格納可能
  - 1sあたり100個以上のリクエストを定常的に処理している場合: keyの先頭名を文字列ランダムにする
  - AWSのマネジメントバックボーンネットワークを活用した高速ファイル転送サービス
    - バケットに対して、Accelerationを有効化する。最大30分以内には高速になる
