# RDSについて

### (参考) AWS Black Belt Online Seminar 2017 Amazon Relational Database Service (Amazon RDS)

- Multi-AZ
  - アプリ側での対処の必要なし(endpointは変わらない)
  - スタンバイ状態のDBはアクセス不可

- フェイルオーバーの発生タイミング
  - インスタンスやハードウェア障害
  - パッチ適用などのメンテナンス時間
  - 手動リブートに強制フェイルオーバー指定

- リードレプリカ(RR)
  - 5台まで (Auroraは15台)
  - インスタンスやストレージをマスターと異なるタイプに設定できる
  - スタンドアロンのDBインスタンスに昇格でき、MySQL, MariaDBではパラメータ設定で書き込みも可能
  - MySQL MariaDB PostgresSQL Auroraに対応

- スケールアップ
  - インスタンスサイズは拡大・縮小できる
  - ディスクサイズは拡張はできるが、縮小はできない

- DBインスタンスタイプ
  - R3: メモリ重視
  - M4: CPU重視
  - T2: 開発・検証

- RDSでのストレージタイプ
  - SSD(GP2): 高性能 + バースト (100 - 10,000 IOPS)
  - プロビジョンドIOPS(PIOPS): 安定した高性能(1,000 - 30,000 IOPS)

- スナップショットとリストア
  - 自動的なバックアップ
    - 自動スナップショットとトランザクションログをs3に保存
  - スナップショット 
    - 1日1回自動取得(バックアップウィンドウで指定した時間帯)
    - 保存期間は最大35日分
  - リストア
    - スナップショットを元にDBインスタンスを作成
    - Point-in-Timeリカバリ
      - 指定した時刻(5分以上前)の状態になるようにDBインスタンスを作成

- スナップショットについて
  - 自動スナップショット
    - DBインスタンスのサイズと同じサイズまでストレージコストが無料
    - DBインスタンス削除と同時に削除される(手動スナップショットは削除されない)
    - マルチAZであれば、スタンバイから取得するのでアプリケーションへの影響がない

- リネームの注意点
  - DNSの切り替え
    - 10分以内
    - 同一リージョン内にて名前の重複はできない
    - クライアント側のDNSキャッシュのTTlにも依存(30秒未満を推奨)
  - リネームするときに引き継がないもの
    - Cloudwatchのメトリクス名
    - EventsのIdentifer
  - リネームしても引き継ぐもの 
    - マスターとリードレプリカの関係
    - タグ・スナップショット

- ソフトウェアメンテナンス
  - メンテナンスウィンドウで指定した曜日・時間帯に自動実施
  - 安全性・堅牢性に関わるソフトウェア
  - パッチを自動適用(リブートを伴うケースあり)
  - メンテナンスは数ヶ月に１度(毎週からなずではない)
  - 指定した時間帯の数分間で実施
  - マルチAZにしておくことでダウンタイムを1-2分にすることが可能

- 監視(CloudWatch)
  - 各種メトリクスを60s間隔で取得可能
  - 拡張モニタリング
    - 50種類以上のOSメトリクス
    - プロセス一覧
    - 特定メトリクスアラーム
    - Cloudwatch Logsへの出力
    - 3rd partyツール連携


- 各種制限
  - RDSインスタンス数: 40
  - 1マスターあたりのリードレプリカ数: 5
  - 手動スナップショット数: 100
  - すべてのDBインスタンスの合計ストレージ: 100TB

- DBインスタンスの暗号化
  - 保管時のインスタンスとスナップショットの暗号化が可能
    - DBインスタンス　自動バックアップ リードレプリカ スナップショットが対象
    - AES-256暗号化アルゴリズムを利用(パフォーマンス影響を最小限に)
    - KMSで鍵管理が可能
    - リードレプリカも同じ鍵で暗号化される
    - インスタンス作成時にのみ設定可能
      - スナップショットのコピーを暗号化してリストアすることは可能
    - 暗号化された DBインスタンスを変更して暗号化を無効にすることはできない
    - 対応するインスタンスタイプ
      - db.m4 db.r3 db.t2.large
